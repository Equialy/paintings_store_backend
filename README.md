# Library Books API

REST‑сервис для управления библиотечными книгами, читателями и учётом выдач с асинхронным FastAPI и PostgreSQL.

---

## Содержание

* [Функции](#функции)
* [Технологии](#технологии)
* [Структура проекта](#структура-проекта)
* [Начало работы](#начало-работы)
  * [Быстрый старт](#быстрый-старт)
  * [Запуск приложения](#запуск-приложения)
* [Аутентификация](#аутентификация)
* [Эндпоинты API](#эндпоинты-api)
  * [Регистрация и вход](#регистрация-и-вход)
  * [CRUD для книг](#crud-для-книг)
  * [CRUD для читателей](#crud-для-читателей)
  * [Выдача и возврат](#выдача-и-возврат)
* [Бизнес-логика](#бизнес-логика)
* [Принятые решения](#принятые-решения)
* [Фичу которую можно реализовать](#фичу-которую-можно-реализовать)

---


Domain отвечает за бизнес‑логику корзины,

Infrastructure хранит модели и репозитории,

Presentation — за конечные HTTP‑эндпоинты.

## Функции

* **Аутентификация** пользователей через JWT
* **CRUD** для картин и пользователей
* **Выдача и возврат** книг с учётом остатков
* **Бизнес-правила**:

  * Не более 3 книг одновременно на одного читателя
  * Автоматическое изменение количества экземпляров при выдаче/возврате
* **Миграции Alembic**, включая миграцию для поля `description` у книг
* **Юнит-тесты** Pytest для проверки логики и защищённых эндпоинтов

---



## Технологии

* Язык: Python 3.13
* Фреймворк: FastAPI
* База данных: PostgreSQL 
* ORM: SQLAlchemy
* Миграции: Alembic
* Аутентификация: JWT (python-jose 3.5.0), хеширование паролей bcrypt 4.3.0
* Валидация данных: Pydantic 2.11.5
* Тестирование: Pytest

---

##  Структура проекта

```commandline
    src/
    ├── domain/
    │   ├── accounts/           # схемы, use‑cases, интерфейсы репозиториев и сервисов, jwt сервисы
    │   ├── pictures/            # схемы, use‑cases, интерфейсы репозиториев и сервисов
    │   └── users/            # схемы, use‑cases, интерфейсы репозиториев и сервисов
    ├── infrastructure/
    │   ├── database/
    │   │   ├── migrations/     # Alembic‑миграции
    │   │   ├── models/         # SQLAlchemy‑модели (Pictures,  Users)
    │   │   └── repositories/   # CRUD‑репозитории
    │   └── base.py             # DeclarativeBase, сессии
    ├── presentation/
    │   ├── api/                # FastAPI‑роутеры
    │   ├── dependencies/       # Зависимости
    │   ├── main.py             # точка входа FastAPI
    │   └── routers.py          # подключение роутеров
    │── utils/                  # Инструменты
    ├── middleware.py           # Настройка корсов
    └──  settings.py            # настройка через Pydantic BaseSettings
    tests/
    └── endpoints_tests/        # тесты

```

---
## Начало работы

## Быстрый старт

1. **Клонировать репозиторий**  
   ```bash
   git clone https://gitlab.com/Equialy/library_books.git
   cd library_books
   ```

2. **Создать виртуальное окружение и установить зависимости**
    ```bash
   python3 -m venv .venv
    source .venv/bin/activate
    pip install -r requirements.txt
    ```
3. **Настроить переменные окружения
Создайте файл .env в корне с параметрами по шаблону .env.example**

    
4. **Запустить миграции**
    ```bash
   alembic upgrade head
   ```
   
### Запуск приложения
 **Запустить сервер**
 ```bash
   uvicorn src.presentation.main:app --reload --port 8001
   ```

   Доступ к API: `http://localhost:8000/`, документация Swagger: `http://localhost:8000/docs`.

## Аутентификация

* **POST /api/v1/register**: регистрация библиотекаря (`username`,`email`, `password`). Пароль хешируется bcrypt. Возвращает `{
  "access_token": "string",
  "token_type": "string"
}`
* **POST /api/v1/login**: вход, возвращает JWT (действителен 30 минут). Возвращает `{
  "access_token": "string",
  "token_type": "string"
}`
* Все остальные эндпоинты требуют заголовок `Authorization: Bearer <token>`.

Токены обрабатываются через `python-jose`. Выбраны JWT для масштабируемости, bcrypt — для надёжного хеширования.




### **Через curl**

 **На windows**
   ```commandline
    
   curl.exe -X POST "http://127.0.0.1:8000/api/v1/register" `
     -H "Accept: application/json" `
     -H "Content-Type: application/json" `
     -d '{\"username\":\"Efty\", \"email\":\"efty@gmail.com\", \"password\":\"qwerty\"}'

   ```

**Linux**

   ```
   curl -X POST http://127.0.0.1:8000/api/v1/register \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -d '{"username":"Efty", "email":"efty@gmail.com", "password":"qwerty"}'
   ```
    


---

## Эндпоинты API

### Регистрация и вход

| Метод | Путь               | Описание                 |
| ----- |--------------------| ------------------------ |
| POST  | `/api/v1/register` | Регистрация библиотекаря |
| POST  | `/api/v1/login`    | Вход, получение JWT      |

### CRUD для книг

| Метод  | Путь                      | Описание                             |
| ------ |---------------------------|--------------------------------------|
| GET    | `/api/v1/books/{book_id}` | Получить книгу по ID без авторизации |
| POST   | `/api/v1/books/`          | Создать новую книгу                  |
| PUT    | `/api/v1/books/{book_id}` | Обновить данные книги                |
| DELETE | `/api/v1/books/{book_id}` | Удалить книгу                        |

### CRUD для читателей

| Метод  | Путь                                | Описание                 |
| ------ |-------------------------------------| ------------------------ |
| GET    | `/api/v1/readers/{reader_id}`       | Получить читателя по ID  |
| GET    | `/api/v1/readers/{email}`           | Получить читателя по ID  |
| POST   | `/api/v1/readers`                | Добавить нового читателя |
| PUT    | `/api/v1/readers/{reader_id}` | Обновить данные читателя |
| DELETE | `/api/v1/readers/{reader_id}` | Удалить читателя         |

### Выдача и возврат

| Метод | Путь                     | Описание                               |
|-------|--------------------------|----------------------------------------|
| POST  | `/api/v1/borrow/`        | Выдать книгу (`book_id`, `reader_id`)  |
| PATCH | `/api/v1/return_borrow/` | Вернуть книгу (`book_id`, `borrow_id`) |


### Информация о читателях (управдляется только авторизированными пользователями)

| Метод | Путь                                    | Описание                                                    |
| ----- |-----------------------------------------|-------------------------------------------------------------|
| POST  | `/api/v1/list_books/`                   | Получить список книг с использованием пагинации             |
| POST  | `/api/v1/list_borrow_books/{reader_id}` | Получить список книг взятые читателем и еще не возвращенные |

### Запросы

---

## Бизнес-логика

1. **Проверка доступности**: `quantity`> 0, иначе ошибка; при выдаче — декремент и запись в `borrowed_books` с `return_date = NULL`.
2. **Ограничение**: не более 3 одновременных выдач на одного читателя.
3. **Правила возврата**: книга может быть возвращена только при наличии активной выдачи; при возврате — инкремент `quantity` и установка `return_date`.

---

## Принятые решения

### Структура БД

* `users` — для авторизации библиотекарей
* `books` — данные о книгах управляются библиотекарями
* `readers` — управляются библиотекарями, без паролей
* `borrowed_books` — учёт выдач с датами


## Фичу которую можно реализовать

***Напоминания о просроченных возвратах***

**Добавить фоновую задачу (например Celery), которая раз в день:**
1. Находит в ```borrowed_books``` все записи с ```return_date IS NULL``` и ```borrow_date``` + 30 дней < today.
2. Отправляет email-уведомление читателю ( используя SMTP или сторонний сервис).

**Реализация идеи**
1. В ```infrastructure/tasks.py``` настроить планировщик.

2. В ```domain/borrow/services``` добавить функцию ```get_overdue_loans()```.

3. Настроить в ```settings``` параметры почты.

4. Задача шлёт уведомления, логирует результат и может повторяться по крону.

